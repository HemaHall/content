commonfields:
  id: Symantec Site Review
  version: -1
name: Symantec Site Review
display: Symantec Site Review
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Symantec Site Review (Bluecoat)
configuration:
- display: API Server URL
  name: url
  defaultvalue: https://sitereview.bluecoat.com
  type: 0
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: unsecure
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |-
    import requests
    import json

    requests.packages.urllib3.disable_warnings()

    if not demisto.params()['proxy']:
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    """
    GLOBAL VARIABLES
    """

    SERVER = demisto.params()['url'][:-1] if demisto.params()['url'].endswith('/') else demisto.params()['url']
    BASE_URL = SERVER
    VERIFY_CERTIFICATE = not demisto.params().get('unsecure', False)

    """
    Helper Functions
    """
    def return_error_and_exit(message):
        demisto.results({
            'Type': entryTypes['error'], # note, warning, error
            'ContentsFormat': formats['text'], # json, markdown, file, text
            'Contents': message
        })
        sys.exit(0)

    def http_request(method, url, body=None):

        headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }

        res = requests.request(method, url, verify=VERIFY_CERTIFICATE, headers=headers, data=body)

        if res.status_code < 200 or res.status_code >= 300:
            return_error_and_exit('Failed to retrieve data.\nURL: {}, Status Code: {}, Response: {}'.format(url, res.status_code, res.text))

        return res.json()

    """
    Symantec Site Review Commands
    """

    def list_risk_levels():
        full_url = BASE_URL + '/resource/risklevels'
        res = http_request('GET', full_url)
        return res

    def list_risk_levels_command():
        raw_list = list_risk_levels()
        #demisto.log(raw_list)
        risk_content = []
        for level in raw_list:
            content = {
                "Risk Level": level['number'],
                "Description": level['name']
            }
            risk_content.append(content)

        md = tableToMarkdown('Threat Risk Level Descriptions', risk_content, ['Risk Level', 'Description'])

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': risk_content,
            'HumanReadable': md,
            'EntryContext': {
                'Symantec.Site.RiskLevels': risk_content
            }
        })

    def site_lookup(site):
        #Setting an empty 'captcha' field is required to bypass the ui captcha requirement
        req_body = {}
        req_body['url'] = site
        req_body['captcha'] = ""

        full_url = BASE_URL + '/resource/lookup'
        res = http_request('POST', full_url, json.dumps(req_body))

        return res

    def site_lookup_command():
        """
        urls argument can support a list separated by comma
        """
        sites = demisto.args().get('urls')
        site_details = []
        if isinstance(sites, basestring):
            sites = sites.split(',')
        for site in sites:
            raw_lookup = site_lookup(site)
            site_detail = {}
            md_headers = ['URL','CategorizationID','CategorizationName']
            site_detail['URL'] = raw_lookup['url']
            site_detail['CategorizationID'] = raw_lookup['categorization'][0]['num']
            site_detail['CategorizationName'] = raw_lookup['categorization'][0]['name']
            if raw_lookup['resolvedDetail']['ipAddress']:
                site_detail['ResolvedIP'] = raw_lookup['resolvedDetail']['ipAddress']
                md_headers.append('ResolvedIP')
            if raw_lookup['threatriskLevel']:
                site_detail['ThreatRiskLevel'] = raw_lookup['threatriskLevel']
            else:
                site_detail['ThreatRiskLevel'] = ""
            md_headers.append('ThreatRiskLevel')
            site_details.append(site_detail)

        md = tableToMarkdown('Lookup Categorization', site_details, md_headers)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': site_details,
            'HumanReadable': md,
            'EntryContext': {
                'Symantec.Site': site_details
            }
        })

    def test():

        res = http_request('GET', BASE_URL)
        demisto.results('ok')

    """
    CODE EXECUTION STARTS HERE

    demisto.command() returns the name of the command which executed now
    """
    LOG('command is %s' % (demisto.command(), ))
    try:
        if demisto.command() == 'test-module':
            """
            demisto.command() will return 'test-module' when the Test button in integration page clicked
            """
            test()
        elif demisto.command() == 'symantec-site-lookup':
            site_lookup_command()
        elif demisto.command() == 'symantec-site-list-risklevels':
            list_risk_levels_command()

    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        raise
  type: python
  commands:
  - name: symantec-site-lookup
    arguments:
    - name: urls
      required: true
      description: URLs to lookup. Can be a single value or comma separated  list
        of values.
    outputs:
    - contextPath: Symantec.Site.CategorizationID
      description: Site Categorization Number
      type: string
    - contextPath: Symantec.Site.CategorizationName
      description: Site Categorization Name
      type: string
    - contextPath: Symantec.Site.ResolvedIP
      description: Site Resolved IP Address
      type: string
    - contextPath: Symantec.Site.ThreatRiskLevel
      description: Site Threat Risk Level
      type: string
    description: Symantec WebPulse Site Review Request
  - name: symantec-site-list-risklevels
    arguments: []
    outputs:
    - contextPath: Symantec.Site.RiskLevels
      description: Threat Risk Levels
    description: Threat Risk Level Descriptions
  runonce: false
